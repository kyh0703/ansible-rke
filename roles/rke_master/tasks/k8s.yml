---
- name: disable SELINUX
  shell: "{{ item }}"
  with_items:
    - "setenforce 0"
    - "sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config"

- name: modify systemctl config
  shell: "{{ item }}"
  with_items:
    - |
      cat <<EOF | tee /etc/sysctl.d/k8s.conf
      net.bridge.bridge-nf-call-ip6tables = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.ipv4.ip_forward = 1
      EOF
    - sysctl --system

- name: Get kubectl stable version
  register: latest_kubectl
  ansible.builtin.uri:
    url: https://dl.k8s.io/release/stable.txt
    return_content: yes

- name: download kubectl
  ansible.builtin.get_url:
    url: "https://dl.k8s.io/release/{{ latest_kubectl.content }}/bin/linux/amd64/kubectl"
    dest: /root

- name: install kubectl
  shell: sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
